<%
  if files[0]
    # this is the same for every file and if we don't cache it here it will hit the db for every file
    version = files[0].inv_version
    version_id = version.to_param
    object = version.inv_object
    object_id = object.to_param

    # would be cleaner code if we had this check inside the file.each but it is slower for pages with many files
    can_download_object = current_user_can_download?(object)
    any_file_too_large = false
%>
    <%
      files.each do |file|
        file_basename = File.basename(file.pathname)
        file_too_large = file.exceeds_download_size?
        any_file_too_large ||= file_too_large
    %>
      <tr>
        <th>
          <% if can_download_object && !file_too_large %>
            <%# not using link_to speeds this up %>
            <a href="/d/<%= object_id %>/<%= version_id %>/<%= file.to_param %>">
              <%= file_basename %>
            </a>
          <% else %>
            <%= file_basename %>
          <% end %>
        </th>
        <td>
          <%= clean_mime_type(file.mime_type) %>
        </td>
        <td style="width: 100%;">
          <%= number_to_storage_size(file.full_size) %>
        </td>
      </tr>
    <%
      end
      %>
  <% if any_file_too_large %>
      <tr>
        <td colspan="3">
          Files larger than <%= max_download_size_pretty %> cannot be downloaded.
          For access to large files, please
          <a href="http://www.cdlib.org/services/uc3/contact.html">contact UC3</a>.
        </td>
      </tr>
  <% end %>
<% end %>
