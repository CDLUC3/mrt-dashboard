name: Ruby

on:
  push:
    branches: [ ghactions ]
  pull_request:
    branches: [ ghactions ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Ruby 2.4
      uses: actions/setup-ruby@v1
      with:
        ruby-version: 2.4
    - name: Setup Bundler 1.17.1
      run: |
        gem uninstall bundler
        gem install bundler:1.17.1

    - name: Ensure sqlite3 installation
      run: |
        # https://stackoverflow.com/a/34151536/3846548
        sudo apt-get install libsqlite3-dev

    - name: Bundle install
      run: |
        bundle update sqlite3
        bundle install --jobs 4 --retry 3

    - name: Rubocop checks
      run: |
        bundle exec rubocop

    - name: Start mysql
      run: |
        sudo systemctl start mysql
        # wait for mysql service to respond

    - name: Wait for mysql
      run: |
        which mysql && until mysql -u root -e "show status" &>/dev/null; do sleep 1; done
        # set up MySQL 5.7

    - name: Set empty password
      run: |
        sudo mysql -e "use mysql; update user set authentication_string=PASSWORD('') where User='root'; update user set plugin='mysql_native_password';FLUSH PRIVILEGES;"

    - name: Upgrade mysql
      run: |
        sudo mysql_upgrade -u root

    - name: Restart mysql
      run: |
        sudo systemctl restart mysql
        # update gems
        #gem update --system

    - name: Run rspec tests
      run: |
        cp .config-travis/* config
        bundle exec rspec spec/controllers

    - name: xvfb setup
      run: |
        export DISPLAY=:99.0
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &


    - name: Copy test config
      run: |
        travis-prep.sh

    - name: Run rspec tests
      run: |
        bundle exec rspec spec/controllers

    - name: Coverage Checks
      run: |
        bundle exec rake coverage
